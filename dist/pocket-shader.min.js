var a=class{container;canvas;ctx=null;vertex;fragment;maxPixelRatio;speed;state="stopped";opts={};program=!1;mouse={x:.5,y:.5};mouseSmoothed={x:.5,y:.5};mouseSmoothing=.1;builtinUniforms={u_time:0,u_resolution:[0,0],u_mouse:[.5,.5]};_positionBuffer=null;_builtinUniformLocations=new Map;_uniformLocations=new Map;_uniforms;_time=0;_resizeObserver;_canvasRectCache;_listeners=new Map;_arg1;_arg2;constructor(t,e){this._arg1=t,this._arg2=e;let s=!0;if(typeof t=="object"&&"autoInit"in t&&t.autoInit===!1&&(s=!1),typeof e=="object"&&"autoInit"in e&&e.autoInit===!1&&(s=!1),s){if(typeof globalThis.window>"u"){import.meta?.env?.DEV&&console.warn("PocketShader is not running in a browser environment.  Aborting automatic initialization.");return}globalThis.document?.readyState==="loading"?document.addEventListener("DOMContentLoaded",this.init):this.init()}}get uniforms(){return this._uniforms}set uniforms(t){this._uniforms=t,this.state.match(/paused|stopped/)&&this.render()}get time(){return this._time}set time(t){this._time=t,this.builtinUniforms.u_time=t}get resolution(){return{width:this.canvas?.width,height:this.canvas?.height}}init(){let t,e;this._arg1 instanceof Element?(t=this._arg1,e=this._arg2):typeof this._arg1=="string"?(t=document.querySelector(this._arg1),e=this._arg2):(t=document.body,e=this._arg1),this.opts=e??{},this.opts.mouseTarget=e?.mouseTarget??"canvas",this.speed=e?.speed??1,this.mouseSmoothing=e?.mouseSmoothing??.1,this.maxPixelRatio=e?.maxPixelRatio??(globalThis.window?.devicePixelRatio||1),e?.canvas?(this.canvas=e.canvas,t=this.canvas.parentElement):this.canvas=document.createElement("canvas"),this.container=t??document.body,this._canvasRectCache=this.canvas.getBoundingClientRect(),this.vertex=e?.vertex??`#version 300 es
layout(location = 0) in vec4 a_position;out vec2 vUv;void main() {vUv = a_position.xy * 0.5 + 0.5;gl_Position = a_position;}`,this.fragment=e?.fragment??`#version 300 es
precision mediump float;uniform float u_time;in vec2 vUv;out vec4 color;void main() {color = vec4(vUv, 0.5 + 0.5 * sin(u_time), 1.0);}`,this.vertex.startsWith("#version")||(this.vertex=`#version 300 es
`+this.vertex);let s=this.fragment.split(`
`),i=[s[0].startsWith("#version")?s.shift():"#version 300 es"];return this.fragment.includes("precision")||i.push(`precision mediump float;
`),this.fragment=i.concat(s).join(`
`),this._uniforms=e?.uniforms??{},this._setupCanvas(),this._resizeObserver=new ResizeObserver(this.resize),this._resizeObserver.observe(this.canvas),this._resizeObserver.observe(this.container),this.compile(),e?.mousePosition&&(this.mouse=e.mousePosition),e?.autoStart===!0?this.start():this._resize(),(this.container.clientWidth===0||this.container.clientHeight===0)&&console.error("PocketShader container has a width or height of 0px.  The canvas will not be visible until the container has a non-zero size size.",{container:this.container,canvas:this.canvas,this:this}),this}start(){switch(this.state){case"stopped":case"paused":this.state="running",this._resize(),this.render();break;case"running":break;case"disposed":throw new Error("Cannot start a disposed PocketShader.  Call restart() instead.")}return this}pause(){return this.state="paused",this}stop(){return this.state="stopped",this.time=0,this}restart(){switch(this.state){case"running":break;case"stopped":case"paused":this.start();break;case"disposed":this.reload()}return this}reload(){let t=this.state==="running";return t&&this.pause(),this.dispose(),this.state="stopped",this.compile(),this._resize(),t&&this.start(),this}_resize=()=>{let t=this.container instanceof HTMLBodyElement?window.innerWidth:this.container.clientWidth,e=this.container instanceof HTMLBodyElement?window.innerHeight:this.container.clientHeight;return(this.canvas.width!==t||this.canvas.height!==e||this.maxPixelRatio!==this.opts.maxPixelRatio)&&(this.canvas.width=t*this.maxPixelRatio,this.canvas.height=e*this.maxPixelRatio,this.canvas.style.width=t+"px",this.canvas.style.height=e+"px",this.builtinUniforms.u_resolution[0]=t*this.maxPixelRatio,this.builtinUniforms.u_resolution[1]=e*this.maxPixelRatio),this._canvasRectCache=this.canvas.getBoundingClientRect(),this.state.match(/paused|stopped/)&&this.render(),this};resize=h(this._resize);render(){let t=0,e=s=>{if(this.state==="disposed")return;if(!this.ctx)throw new Error("WebGL context lost.");s*=.001;let i=Math.min(s-t,.1);this._listeners.size&&this._emit(this.time,i),this.state==="running"&&(this.time+=i*this.speed),t=s,this.mouseSmoothed.x+=(this.mouse.x-this.mouseSmoothed.x)*(1-this.mouseSmoothing),this.mouseSmoothed.y+=(this.mouse.y-this.mouseSmoothed.y)*(1-this.mouseSmoothing),this.builtinUniforms.u_mouse[0]=this.mouseSmoothed.x,this.builtinUniforms.u_mouse[1]=this.mouseSmoothed.y,this.ctx.viewport(0,0,this.ctx.canvas.width,this.ctx.canvas.height),this.ctx.useProgram(this.program);let n=this._builtinUniformLocations.get("a_position"),o=this._builtinUniformLocations.get("u_resolution"),c=this._builtinUniformLocations.get("u_mouse"),u=this._builtinUniformLocations.get("u_time");this.ctx.enableVertexAttribArray(n),this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this._positionBuffer),this.ctx.vertexAttribPointer(n,2,this.ctx.FLOAT,!1,0,0),this.ctx.uniform2f(o,this.builtinUniforms.u_resolution[0],this.builtinUniforms.u_resolution[1]),this.ctx.uniform2f(c,this.builtinUniforms.u_mouse[0],this.builtinUniforms.u_mouse[1]),this.ctx.uniform1f(u,this.builtinUniforms.u_time);for(let[m,d]of this._uniformLocations)this._setUniform(this.ctx,d,this.uniforms[m]);this.ctx.drawArrays(this.ctx.TRIANGLES,0,6),this.state==="running"&&requestAnimationFrame(e)};return requestAnimationFrame(e),this}setMousePosition=t=>{this.mouse.x=(t.clientX-this._canvasRectCache.left)/this._canvasRectCache.width,this.mouse.y=(this._canvasRectCache.height-(t.clientY-this._canvasRectCache.top)-1)/this._canvasRectCache.height};setTouchPosition=t=>{this.opts.preventScroll===!0&&t.preventDefault(),this.setMousePosition(t.touches[0])};on=(t,e)=>(this._listeners.set(t,e),this);_emit=(t,e)=>{for(let[s,i]of this._listeners)switch(s){case"render":i({time:t,delta:e});break}};compile(){if(this.ctx=this.canvas.getContext("webgl2"),!this.ctx)throw new Error("WebGL2 context not found.");let t=this._createShader(this.ctx,this.ctx.VERTEX_SHADER,this.vertex),e=this._createShader(this.ctx,this.ctx.FRAGMENT_SHADER,this.fragment);this.program=this._createProgram(this.ctx,t,e),this._builtinUniformLocations.set("a_position",this.ctx.getUniformLocation(this.program,"a_position")),this._builtinUniformLocations.set("u_resolution",this.ctx.getUniformLocation(this.program,"u_resolution")),this._builtinUniformLocations.set("u_mouse",this.ctx.getUniformLocation(this.program,"u_mouse")),this._builtinUniformLocations.set("u_time",this.ctx.getUniformLocation(this.program,"u_time")),this.opts.fragment&&this._validateUniforms(this.opts.fragment);for(let s in this.uniforms)this._uniformLocations.set(s,this.ctx.getUniformLocation(this.program,s));this._positionBuffer=this.ctx.createBuffer(),this.ctx.bindBuffer(this.ctx.ARRAY_BUFFER,this._positionBuffer),this.ctx.bufferData(this.ctx.ARRAY_BUFFER,new Float32Array([-1,-1,1,-1,-1,1,-1,1,1,-1,1,1]),this.ctx.STATIC_DRAW)}getMouseTarget=()=>{switch(this.opts.mouseTarget){case"container":return this.container??window;case"window":return window;case"canvas":default:return this.canvas}};_setupCanvas(){if(!this.container)throw new Error("Container not found.");if(this.canvas.style.setProperty("contain","strict"),this.container instanceof HTMLBodyElement){let t=window.innerWidth,e=window.innerHeight;this.canvas.style.setProperty("width",`${t}px`),this.canvas.style.setProperty("height",`${e}px`),this.canvas.style.setProperty("position","fixed"),this.canvas.style.setProperty("inset","0"),this.canvas.style.setProperty("zIndex","0")}else this.canvas.style.setProperty("width",`${this.container.clientWidth}px`),this.canvas.style.setProperty("height",`${this.container.clientHeight}px`),this.canvas.style.setProperty("position","absolute"),this.canvas.style.setProperty("inset","0"),this.canvas.style.setProperty("zIndex","1"),this.container.style.position===""&&(this.container.style.position="relative");this.getMouseTarget().addEventListener("mousemove",this.setMousePosition),this.getMouseTarget().addEventListener("touchmove",this.setTouchPosition,{passive:!1}),Array.from(this.container.children).includes(this.canvas)||this.container.appendChild(this.canvas),window.addEventListener("resize",this.resize),window.addEventListener("scroll",this._updateRectCache)}_updateRectCache=h(()=>{this._canvasRectCache=this.canvas.getBoundingClientRect()});_createProgram(t,e,s){let i=t.createProgram();return t.attachShader(i,e),t.attachShader(i,s),t.linkProgram(i),t.getProgramParameter(i,t.LINK_STATUS)?i:(console.error(t.getProgramInfoLog(i)),t.deleteProgram(i),!1)}_createShader(t,e,s){let i=t.createShader(e);return t.shaderSource(i,s),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)?i:(console.error("Failed to compile shader:"),console.error({type:e,source:s,this:this}),console.error(t.getShaderInfoLog(i)),t.deleteShader(i),!1)}_setUniform(t,e,s){if(e===null)return;let{type:i,value:n}=s;switch(i){case"float":t.uniform1f(e,n);break;case"vec2":t.uniform2fv(e,n);break;case"vec3":t.uniform3fv(e,n);break;case"vec4":t.uniform4fv(e,n);break;case"int":t.uniform1i(e,n);break;default:throw new Error(`Unsupported uniform type: ${i}`)}}_validateUniforms(t){let e=/uniform\s+(\w+)\s+(\w+)\s*;/g,s;for(;(s=e.exec(t))!==null;){let[,,i]=s;if(![...this._builtinUniformLocations.keys(),...Object.keys(this.uniforms)].some(n=>n===i))throw new Error(`Uniform "${i}" is referenced in the shader, but no value was provided in PocketShaderOptions.uniforms.`)}return this}_cleanupListeners(){this.canvas.removeEventListener("mousemove",this.setMousePosition),this.canvas.removeEventListener("touchmove",this.setTouchPosition),window.removeEventListener("resize",this.resize),window.removeEventListener("scroll",this._updateRectCache),this._resizeObserver.disconnect(),this._listeners.clear()}dispose(){this.state="disposed",this._cleanupListeners(),this._builtinUniformLocations.clear(),this._uniformLocations.clear(),this.canvas?.remove(),this.ctx?.getExtension("WEBGL_lose_context")?.loseContext(),this.ctx=null}};function h(r,t=50,e=75){let s,i=0;return function(...n){let o=performance.now();clearTimeout(s),o-i>=t&&(i=o,r(...n)),s=setTimeout(()=>{r(...n)},e)}}export{a as PocketShader};
